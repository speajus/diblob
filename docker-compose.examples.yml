services:
  # Install workspace dependencies once into the shared node_modules volume.
  # Other services depend on this finishing successfully, so they don't race
  # each other running `pnpm install` against the same volume.
  deps:
    image: node:22
    working_dir: /app
    volumes:
      - .:/app
      - app_node_modules:/app/node_modules
    environment:
      CI: "true"
    command: sh -c "corepack enable && pnpm install"

  api:
    image: node:22
    working_dir: /app
    volumes:
      - .:/app
      - app_node_modules:/app/node_modules
    command: sh -c "corepack enable && pnpm --filter example-grpc-server dev"
    ports:
      - "50051:50051"  # gRPC / Connect API
      - "3002:3002"    # diblob-visualizer UI / SSE
    environment:
      # Ensure the server binds on all interfaces inside the container
      EXAMPLE_GRPC_SERVER_HOST: 0.0.0.0
      EXAMPLE_GRPC_SERVER_VISUALIZER_HOST: 0.0.0.0
    depends_on:
      deps:
        condition: service_completed_successfully

  web:
    image: node:22
    working_dir: /app
    volumes:
      - .:/app
      - app_node_modules:/app/node_modules
    # Expose Vite dev server on 0.0.0.0 so it is accessible from the host
    command: sh -c "corepack enable && pnpm --filter example-web-svelte dev -- --host 0.0.0.0 --port 5173"
    ports:
      - "5173:5173"    # Vite dev server
    environment:
      # Point the SPA at the API and visualizer within the compose network
      VITE_USER_SERVICE_URL: http://api:50051
      VITE_VISUALIZER_EVENTS_URL: http://api:3002/events
    depends_on:
      deps:
        condition: service_completed_successfully
      api:
        condition: service_started

  worker:
    image: node:22
    working_dir: /app
    volumes:
      - .:/app
      - app_node_modules:/app/node_modules
    command: sh -c "corepack enable && pnpm --filter example-worker-tasks dev"
    depends_on:
      deps:
        condition: service_completed_successfully
      api:
        condition: service_started

volumes:
  app_node_modules:

